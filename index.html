<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Form Input Data Pengiriman & Penerimaan</title>
    
    <!-- Memuat Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Google Fonts (Inter) untuk tipografi yang konsisten -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Memuat Tone.js untuk efek suara interaktif -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">


    <style>
        /* Mencegah 'pull-to-refresh' dan scroll chaining pada mobile */
        html {
            height: 100%;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            overscroll-behavior-y: contain;
            background-color: #111827; /* bg-gray-900 */
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(to bottom right, #38bdf8, #3b82f6);
            z-index: -1;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
        body.app-active::before {
            opacity: 0;
        }
        #login-screen, #app-container {
            transition: opacity 0.5s ease-in-out;
        }
        
        /* Mencegah zoom otomatis saat mengisi form di mobile */
        @media (max-width: 768px) {
            input[type="text"],
            input[type="password"],
            input[type="number"],
            input[type="date"],
            input[type="search"],
            input[type="tel"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        /* Gaya UI Kustom */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .table-container::-webkit-scrollbar { width: 8px; height: 6px; }
        .table-container::-webkit-scrollbar-track { background: #1f2937; }
        .table-container::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .auto-uppercase { text-transform: uppercase; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        
        /* Gaya Toast Notification */
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 0.75rem; color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transform: translateX(120%); transition: transform 0.5s ease-in-out; opacity: 0; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast-success { background-color: #16a34a; }
        .toast-error { background-color: #dc2626; }
        .toast-warning { background-color: #d97706; }

        /* Gaya untuk Sorting Tabel */
        .sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px !important; }
        .sortable:hover { background-color: #4b5563; }
        .sort-arrow { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); opacity: 0.4; }
        .sortable.asc .sort-arrow::after { content: '▲'; }
        .sortable.desc .sort-arrow::after { content: '▼'; }
        .sortable.asc .sort-arrow, .sortable.desc .sort-arrow { opacity: 1; }
        
        th { white-space: nowrap; }

        /* Gaya Skeleton Loader */
        .skeleton { background-color: #4a5568; border-radius: 0.25rem; position: relative; overflow: hidden; }
        .skeleton::after { content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }
        
        /* Gaya untuk Toggle Switch */
        .toggle-switch:checked ~ .dot {
            transform: translateX(100%);
            background-color: #48bb78;
        }
        .toggle-switch:checked ~ .block {
            background-color: #3182ce;
        }

        /* Gaya Notifikasi Istirahat */
        #break-notification.show {
            transform: translateX(0) translateY(-50%);
        }
    </style>
</head>
<body class="text-gray-200">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-black/20 backdrop-blur-md border-2 border-white/30 p-8 rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-bold text-center text-white mb-8">Login</h1>
            <form id="login-form" class="space-y-6">
                <div class="relative">
                    <i class="fa fa-user absolute left-4 top-1/2 -translate-y-1/2 text-white/50"></i>
                    <select id="role-select" class="bg-black/30 border-2 border-white/30 text-white text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full pl-12 p-3 appearance-none">
                        <option class="text-black" value="kirim">BAGIAN KIRIM LANGSIR</option>
                        <option class="text-black" value="terima">BAGIAN TERIMA LANGSIR</option>
                    </select>
                </div>
                <div class="relative">
                    <i class="fa fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-white/50"></i>
                    <input type="password" id="password" class="bg-black/30 border-2 border-white/30 text-white text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full pl-12 p-3" placeholder="Password" required>
                </div>
                <p id="login-error" class="text-red-300 text-sm text-center hidden">Password atau peran salah.</p>
                <button type="submit" class="w-full text-blue-800 bg-sky-300 hover:bg-sky-400 focus:ring-4 focus:outline-none focus:ring-sky-200 font-semibold rounded-lg text-md px-5 py-3 text-center transition-colors duration-300">LOGIN</button>
            </form>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="hidden p-2 sm:p-4 md:p-8" style="opacity: 0;">
        
        <!-- Header with Logout Button and Toggles -->
        <div class="fixed top-4 right-4 z-50 flex items-center gap-4 no-print">
             <!-- SYNC STATUS INDICATOR -->
             <div id="sync-status-container" class="flex items-center space-x-2 bg-gray-800/50 backdrop-blur-sm p-2 rounded-full text-sm font-medium">
                <span id="sync-icon"></span>
                <span id="sync-text"></span>
                <button id="manual-sync-btn" class="hidden" title="Coba Sinkronisasi Ulang">
                    <i class="fa-solid fa-arrows-rotate text-white"></i>
                </button>
            </div>
             <!-- Fitur Anti Duplikat -->
            <div class="flex items-center space-x-2 bg-gray-800/50 backdrop-blur-sm p-2 rounded-full">
                <label for="anti-duplicate-toggle" id="anti-duplicate-label" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-sm font-medium text-gray-300">Anti Duplikat</span>
                    <div class="relative">
                        <input type="checkbox" id="anti-duplicate-toggle" class="sr-only toggle-switch">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                </label>
            </div>
             <!-- Fitur Mode Lancar/Cepat -->
            <div class="flex items-center space-x-2 bg-gray-800/50 backdrop-blur-sm p-2 rounded-full">
                <label for="anti-lag-toggle" id="anti-lag-label" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-sm font-medium text-gray-300">Mode Lancar</span>
                    <div class="relative">
                        <input type="checkbox" id="anti-lag-toggle" class="sr-only toggle-switch">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                </label>
            </div>
             <button id="logout-btn" class="p-3 bg-red-600 hover:bg-red-700 text-white rounded-full shadow-lg transition-colors" title="Logout">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                 </svg>
             </button>
        </div>

        <!-- Kontainer utama aplikasi -->
        <div class="w-full max-w-5xl mx-auto pt-24 sm:pt-0">
            
            <!-- Kontainer Form Input -->
            <div class="bg-gray-800 p-4 sm:p-8 rounded-2xl shadow-2xl mb-8">
                
                <!-- Kontainer untuk Form Pengiriman -->
                <div id="form-kirim-container" class="hidden">
                    <div class="text-center mb-8"><h1 class="text-2xl sm:text-3xl font-bold text-white">INPUT DATA PENGIRIMAN</h1><p class="text-gray-400 mt-2">Isi semua kolom pengiriman di bawah ini.</p></div>
                    <form name="form-kirim" id="form-kirim" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div><label for="tanggal-kirim" class="block mb-2 text-sm font-medium text-gray-300">Tanggal</label><input type="date" id="tanggal-kirim" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                            <div>
                                <label for="no_bpb-kirim" class="block mb-2 text-sm font-medium text-gray-300">No. BPB</label>
                                <input type="tel" id="no_bpb-kirim" inputmode="numeric" placeholder="Contoh: BPB/2024/VII/001" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="tujuan-kirim" class="block mb-2 text-sm font-medium text-gray-300">Tujuan</label>
                                <select id="tujuan-kirim" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required>
                                    <option value="WH 07">WH 07</option>
                                    <option value="WH 05">WH 05</option>
                                    <option value="WH 08">WH 08</option>
                                </select>
                            </div>
                            <div><label for="pengirim-kirim" class="block mb-2 text-sm font-medium text-gray-300">Nama Pengirim</label><input type="text" id="pengirim-kirim" placeholder="NAMA LENGKAP PENGIRIM" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                        </div>
                        <hr class="border-gray-600">
                        <!-- Kontainer untuk item barang yang dapat ditambahkan secara dinamis -->
                        <div class="space-y-4" id="items-container-kirim">
                            <div class="item-row grid grid-cols-12 gap-4 items-end">
                                <div class="col-span-7">
                                    <label class="block mb-2 text-sm font-medium text-gray-300">Kode Barang</label>
                                    <input type="text" name="Kode Barang" list="item-codes-list" placeholder="Contoh: BRG-XYZ-001" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required>
                                </div>
                                <div class="col-span-3">
                                    <label class="block mb-2 text-sm font-medium text-gray-300">Jumlah</label>
                                    <input type="number" name="Jumlah" placeholder="Jml" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required min="1">
                                </div>
                                <!-- Tombol hapus item (akan muncul setelah item pertama) -->
                            </div>
                        </div>
                        <!-- Tombol untuk menambahkan baris item baru -->
                        <button type="button" id="add-item-btn-kirim" class="w-full text-blue-400 bg-gray-700 hover:bg-gray-600 focus:ring-4 focus:outline-none focus:ring-gray-500 font-semibold rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Tambah Barang
                        </button>
                        <hr class="border-gray-600">
                        <!-- Kolom Keterangan BARU -->
                        <div>
                            <label for="keterangan-kirim" class="block mb-2 text-sm font-medium text-gray-300">Keterangan (Opsional)</label>
                            <textarea id="keterangan-kirim" placeholder="Contoh: BARANG MUDAH PECAH, HARAP HATI-HATI" rows="3" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3"></textarea>
                        </div>
                        <hr class="border-gray-600">
                        <!-- Tombol submit form pengiriman -->
                        <button type="submit" class="submit-button w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-semibold rounded-lg text-md px-5 py-3 text-center transition-colors duration-300 flex items-center justify-center">Kirim Semua Data</button>
                        <p class="text-sm text-amber-400 text-center mt-2 font-medium">Periksa kembali data Anda. Tindakan ini tidak dapat dibatalkan.</p>
                    </form>
                </div>

                <!-- Kontainer untuk Form Penerimaan (hidden secara default) -->
                <div id="form-terima-container" class="hidden">
                    <div class="text-center mb-8"><h1 class="text-2xl sm:text-3xl font-bold text-white">INPUT DATA PENERIMAAN</h1><p class="text-gray-400 mt-2">Isi semua kolom penerimaan di bawah ini.</p></div>
                    <form name="form-terima" id="form-terima" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div><label for="tanggal-terima" class="block mb-2 text-sm font-medium text-gray-300">Tanggal</label><input type="date" id="tanggal-terima" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                             <div>
                                <label for="no_bpb-terima" class="block mb-2 text-sm font-medium text-gray-300">No. BPB</label>
                                <input type="tel" id="no_bpb-terima" inputmode="numeric" placeholder="Contoh: BPB/2024/VII/001" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6">
                           <div>
                                <label for="tujuan-terima" class="block mb-2 text-sm font-medium text-gray-300">Tujuan</label>
                                <select id="tujuan-terima" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required>
                                    <option value="WH 07">WH 07</option>
                                    <option value="WH 05">WH 05</option>
                                    <option value="WH 08">WH 08</option>
                                </select>
                            </div>
                            <div><label for="penerima-terima" class="block mb-2 text-sm font-medium text-gray-300">Nama Penerima</label><input type="text" id="penerima-terima" placeholder="NAMA LENGKAP PENERIMA" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div>
                        </div>
                        <hr class="border-gray-600">
                        <!-- Kontainer untuk item barang yang dapat ditambahkan secara dinamis -->
                        <div class="space-y-4" id="items-container-terima">
                            <div class="item-row grid grid-cols-12 gap-4 items-end">
                                <div class="col-span-7">
                                    <label class="block mb-2 text-sm font-medium text-gray-300">Kode Barang</label>
                                    <input type="text" name="Kode Barang" list="item-codes-list" placeholder="Contoh: BRG-XYZ-001" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required>
                                </div>
                                <div class="col-span-3">
                                    <label class="block mb-2 text-sm font-medium text-gray-300">Jumlah</label>
                                    <input type="number" name="Jumlah" placeholder="Jml" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required min="1">
                                </div>
                                <!-- Tombol hapus item (akan muncul setelah item pertama) -->
                            </div>
                        </div>
                        <!-- Tombol untuk menambahkan baris item baru -->
                        <button type="button" id="add-item-btn-terima" class="w-full text-blue-400 bg-gray-700 hover:bg-gray-600 focus:ring-4 focus:outline-none focus:ring-gray-500 font-semibold rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-300 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Tambah Barang
                        </button>
                        <hr class="border-gray-600">
                        <!-- Kolom Keterangan BARU -->
                        <div>
                            <label for="keterangan-terima" class="block mb-2 text-sm font-medium text-gray-300">Keterangan (Opsional)</label>
                            <textarea id="keterangan-terima" placeholder="Contoh: DITERIMA DALAM KONDISI BAIK" rows="3" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3"></textarea>
                        </div>
                        <hr class="border-gray-600">
                        <!-- Tombol submit form penerimaan -->
                        <button type="submit" class="submit-button w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-semibold rounded-lg text-md px-5 py-3 text-center transition-colors duration-300 flex items-center justify-center">Terima Semua Data</button>
                        <p class="text-sm text-amber-400 text-center mt-2 font-medium">Pastikan data yang diterima sudah sesuai sebelum disimpan.</p>
                    </form>
                </div>
            </div>

            <!-- Kontainer Tabel Data Terkini (Pengiriman dan Penerimaan) -->
            <div id="data-tables-container" class="grid grid-cols-1 gap-8">
                <!-- Tabel Data Pengiriman Terkini -->
                <div id="table-kirim-wrapper" class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-2xl hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg sm:text-xl font-bold text-white">Data Pengiriman Hari Ini</h2>
                        <div class="flex items-center space-x-2">
                            <!-- Tombol muat ulang data -->
                            <button id="refresh-kirim-btn" title="Muat Ulang Data" class="text-gray-400 hover:text-white transition-colors p-1 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"></path><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Filter Khusus -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="filter-bpb-kirim" placeholder="Filter No. BPB..." class="table-filter bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <input type="text" id="filter-kode-kirim" placeholder="Filter Kode Barang/Warna..." class="table-filter bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div class="table-container overflow-auto max-h-96">
                        <table id="table-kirim" class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="Tanggal">Tanggal<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="Tujuan">Tujuan<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="No BPB">No. BPB<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="Nama Pengirim">Pengirim<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="Kode Barang">Kode Barang<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-right sortable" data-column="Jumlah">Jumlah<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-right">Selisih</th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3">Keterangan</th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody id="table-body-kirim"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Tabel Data Penerimaan Terkini -->
                <div id="table-terima-wrapper" class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-2xl hidden">
                        <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg sm:text-xl font-bold text-white">Data Penerimaan Hari Ini</h2>
                        <div class="flex items-center space-x-2">
                            <!-- Tombol muat ulang data -->
                            <button id="refresh-terima-btn" title="Muat Ulang Data" class="text-gray-400 hover:text-white transition-colors p-1 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"></path><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Filter Khusus -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="filter-bpb-terima" placeholder="Filter No. BPB..." class="table-filter bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <input type="text" id="filter-kode-terima" placeholder="Filter Kode Barang/Warna..." class="table-filter bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div class="table-container overflow-auto max-h-96">
                        <table id="table-terima" class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="Tanggal">Tanggal<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="Tujuan">Tujuan<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="No BPB">No. BPB<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="Nama Penerima">Penerima<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 sortable" data-column="Kode Barang">Kode Barang<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-right sortable" data-column="Jumlah">Jumlah<span class="sort-arrow"></span></th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3 text-right">Selisih</th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3">Keterangan</th>
                                    <th scope="col" class="px-2 py-2 sm:px-4 sm:py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody id="table-body-terima"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifikasi Istirahat -->
    <div id="break-notification" class="fixed top-1/2 left-0 -translate-y-1/2 w-full bg-yellow-500 text-gray-900 text-2xl font-bold p-4 text-center shadow-lg transform -translate-x-full transition-transform duration-1000 ease-in-out z-[2000] no-print">
        WAKTUNYA ISTIRAHAT
    </div>

    <!-- Kontainer Notifikasi Toast -->
    <div id="toast-container"></div>

    <!-- Datalist untuk Autocomplete Kode Barang -->
    <datalist id="item-codes-list"></datalist>
    
    <script type="module">
        // --- URL SPREADSHEET (PENTING!) ---
        const scriptURLKirim = 'https://script.google.com/macros/s/AKfycbz9oIGTO722d9GFVhcn7D1DonzGpqXvxI0WgqjtQUvyBWpKSKy7AnaSmuBKjTHGSxHkRQ/exec'; 
        const scriptURLTerima = 'https://script.google.com/macros/s/AKfycbwguuJ92Npwy_3ip8HKHkZpRWA-lgNmMbKRXPEXy2WKqiiv-DVQZHpDvqA0TqouobvW/exec'; 

        // --- Elemen Global ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const formKirimContainer = document.getElementById('form-kirim-container');
        const formTerimaContainer = document.getElementById('form-terima-container');
        const formKirim = document.getElementById('form-kirim');
        const formTerima = document.getElementById('form-terima');
        const toastContainer = document.getElementById('toast-container');
        const breakNotification = document.getElementById('break-notification');
        
        // --- Variabel Global ---
        let currentUserRole = null;
        let allDataKirim = [];
        let allDataTerima = [];
        let synth;
        let isAudioReady = false;
        let sortStates = {};
        let isFastModeOn = false; 
        let isAntiDuplicateOn = true;
        let allItemCodes = new Set();
        let isSubmitting = false; 
        let debouncedApplyFilters;
        let debouncedSaveKirim, debouncedSaveTerima;
        let isSending = false;
        let hasShownBreakNotification = false;
        let breakCheckInterval = null;
        let resyncInterval = null;

        // --- Sync Status Logic ---
        let syncStatus = 'syncing'; // 'syncing', 'synced', 'offline'
        const syncStatusContainer = document.getElementById('sync-status-container');
        const syncIcon = document.getElementById('sync-icon');
        const syncText = document.getElementById('sync-text');
        const manualSyncBtn = document.getElementById('manual-sync-btn');
        
        // --- Kredensial Pengguna ---
        const userCredentials = {
            kirim: { username: 'shinpo01', password: 'shinpo01' },
            terima: { username: 'shinpo02', password: 'shinpo02' }
        };

        // --- Fungsi Utilitas ---
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        const getLocalDateString = (isoDateString) => {
            if (!isoDateString) return '';
            const date = new Date(isoDateString);
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().split('T')[0];
        };
        const normalizeTujuan = (tujuan) => String(tujuan || '').replace(/\s/g, '').toUpperCase();
        
        // --- PERUBAHAN LOGIKA PENCOCOKAN KODE BARANG ---
        const advancedNormalizeItemCode = (code) => {
            if (!code) return '';
            let normalized = String(code).toLowerCase();

            // 1. Lakukan penggantian singkatan/ejaan
            const replacements = { 'hjmd': 'hmd', 'ugmd': 'umd', 'brmd': 'bmd', 'belge': 'beige', 'wmd': 'md', 'warna': '' };
            const sortedKeys = Object.keys(replacements).sort((a, b) => b.length - a.length);
            for (const key of sortedKeys) {
                normalized = normalized.replace(new RegExp(key, 'g'), replacements[key]);
            }
            
            // 2. Hapus kata-kata umum yang tidak relevan
            const wordsToRemove = ['ikea', 'mrdiy', 'polos'];
            wordsToRemove.forEach(word => {
                // Menggunakan \b untuk memastikan hanya kata utuh yang dihapus
                normalized = normalized.replace(new RegExp(`\\b${word}\\b`, 'g'), '');
            });

            // 3. Bersihkan dari karakter non-alphanumeric, tapi pertahankan spasi
            normalized = normalized.replace(/[^a-z0-9\s]/g, '');

            // 4. Pisahkan kata, urutkan, lalu gabungkan lagi. Ini membuat urutan tidak berpengaruh.
            // Contoh: "114 sinplas hj" dan "114 hj sinplas" akan menjadi "114hjsinplas"
            const parts = normalized.split(/\s+/).filter(part => part.length > 0);
            parts.sort();
            
            return parts.join('');
        };

        const codesMatch = (code1, code2) => {
            const normalized1 = advancedNormalizeItemCode(code1);
            const normalized2 = advancedNormalizeItemCode(code2);
            if (!normalized1 || !normalized2) return false;
            return normalized1 === normalized2;
        };
        
        const sortData = (data, column, direction) => {
            const isNumeric = ['Jumlah'].includes(column);
            const isDate = ['Tanggal'].includes(column);
            const sortedData = [...data];
            sortedData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                if (isDate) {
                    valA = new Date(valA || 0).getTime();
                    valB = new Date(valB || 0).getTime();
                } else if (isNumeric) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else {
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            return sortedData;
        };
        
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        };
        
        const updateSyncStatusUI = (status) => {
            syncStatus = status;
            syncStatusContainer.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500', 'text-white');
            manualSyncBtn.classList.add('hidden');
            syncIcon.classList.remove('fa-spin');

            // --- BARU: Logika untuk mengunci tombol submit ---
            const submitButtons = document.querySelectorAll('.submit-button');
            const handleButtonState = (button, enable, text, icon, colorClass, hoverClass) => {
                button.disabled = !enable;
                button.innerHTML = icon ? `${icon} ${text}` : text;
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-600', 'hover:bg-green-700', 'bg-gray-500', 'cursor-not-allowed');
                if (enable) {
                    button.classList.add(colorClass, hoverClass);
                } else {
                    button.classList.add('bg-gray-500', 'cursor-not-allowed');
                }
            };

            if (status === 'synced') {
                syncStatusContainer.classList.add('bg-green-500', 'text-white');
                syncIcon.innerHTML = `<i class="fa-solid fa-check-circle"></i>`;
                syncText.textContent = 'Tersinkronisasi';
                submitButtons.forEach(btn => {
                    const isKirim = btn.closest('form').id.includes('kirim');
                    handleButtonState(btn, true, isKirim ? 'Kirim Semua Data' : 'Terima Semua Data', '', isKirim ? 'bg-blue-600' : 'bg-green-600', isKirim ? 'hover:bg-blue-700' : 'hover:bg-green-700');
                });
            } else if (status === 'syncing') {
                syncStatusContainer.classList.add('bg-yellow-500', 'text-white');
                syncIcon.innerHTML = `<i class="fa-solid fa-cloud-arrow-up fa-spin"></i>`;
                syncText.textContent = 'Menyinkronkan...';
                submitButtons.forEach(btn => handleButtonState(btn, false, 'Menunggu Data...', '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"></svg>'));
            } else { // offline
                syncStatusContainer.classList.add('bg-red-500', 'text-white');
                syncIcon.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i>`;
                syncText.textContent = 'Offline';
                manualSyncBtn.classList.remove('hidden');
                submitButtons.forEach(btn => handleButtonState(btn, false, 'Koneksi Terputus', '<i class="fa-solid fa-wifi-slash mr-3"></i>'));
            }
        };

        const fetchData = async (scriptURL) => {
            const response = await fetch(scriptURL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data.result === 'error') throw new Error(data.error);
            return data.filter(row => row && typeof row.rowIndex !== 'undefined');
        };

        const populateAutocomplete = () => {
            const itemCodesList = document.getElementById('item-codes-list');
            if (!itemCodesList) return;
            allDataKirim.forEach(row => allItemCodes.add(String(row['Kode Barang'] || '').trim().toUpperCase()));
            allDataTerima.forEach(row => allItemCodes.add(String(row['Kode Barang'] || '').trim().toUpperCase()));
            itemCodesList.innerHTML = '';
            allItemCodes.forEach(code => {
                if (code) {
                    const option = document.createElement('option');
                    option.value = code;
                    itemCodesList.appendChild(option);
                }
            });
        };

        async function processSubmissionQueue() {
            if (isSending || syncStatus === 'offline') return;

            const queueKirim = JSON.parse(localStorage.getItem('submissionQueueKirim') || '[]');
            const queueTerima = JSON.parse(localStorage.getItem('submissionQueueTerima') || '[]');

            if (queueKirim.length === 0 && queueTerima.length === 0) return;

            isSending = true;

            const processQueue = async (queue, url, type) => {
                let processedCount = 0;
                while (queue.length > 0) {
                    const submission = queue[0];
                    try {
                        const formData = new FormData();
                        for (const key in submission.data) { formData.append(key, submission.data[key]); }
                        formData.append('itemsJSON', JSON.stringify(submission.items));
                        formData.append('action', 'submit');
                        formData.append('logDetails', submission.logDetails);

                        const response = await fetch(url, { method: 'POST', body: formData });
                        const result = await response.json();
                        if (result.result !== 'success') throw new Error(result.error || 'Unknown server error');
                        
                        queue.shift();
                        processedCount++;
                    } catch (error) {
                        console.error(`Gagal mengirim data dari antrean [${type}]:`, error);
                        showToast(`Gagal sinkronisasi data ${type}. Akan dicoba lagi nanti.`, 'error');
                        localStorage.setItem(`submissionQueue${type}`, JSON.stringify(queue));
                        updateSyncStatusUI('offline');
                        return processedCount; 
                    }
                }
                
                localStorage.setItem(`submissionQueue${type}`, JSON.stringify(queue));
                if (processedCount > 0) {
                    showToast(`${processedCount} data ${type.toLowerCase()} berhasil disinkronkan.`, 'success');
                }
                return processedCount;
            };

            try {
                await processQueue(queueKirim, scriptURLKirim, 'Kirim');
                await processQueue(queueTerima, scriptURLTerima, 'Terima');
            } finally {
                isSending = false;
            }
        }

        const setupUIForRole = (role) => {
            const formKirim = document.getElementById('form-kirim-container');
            const tableKirim = document.getElementById('table-kirim-wrapper');
            const formTerima = document.getElementById('form-terima-container');
            const tableTerima = document.getElementById('table-terima-wrapper');

            if (role === 'kirim') {
                formKirim.classList.remove('hidden');
                tableKirim.classList.remove('hidden');
                formTerima.classList.add('hidden');
                tableTerima.classList.add('hidden');
            } else if (role === 'terima') {
                formTerima.classList.remove('hidden');
                tableTerima.classList.remove('hidden');
                formKirim.classList.add('hidden');
                tableKirim.classList.add('hidden');
            }
        };

        const addNewItemRow = (container) => {
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row grid grid-cols-12 gap-4 items-end';
            itemRow.innerHTML = `<div class="col-span-7"><label class="block mb-2 text-sm font-medium text-gray-300 sr-only">Kode Barang</label><input type="text" name="Kode Barang" list="item-codes-list" placeholder="Contoh: BRG-XYZ-001" class="auto-uppercase bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required></div><div class="col-span-3"><label class="block mb-2 text-sm font-medium text-gray-300 sr-only">Jumlah</label><input type="number" name="Jumlah" placeholder="Jml" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" required min="1"></div><div class="col-span-2"><button type="button" class="remove-item-btn w-full h-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
            container.appendChild(itemRow);
            itemRow.querySelector('input[name="Kode Barang"]').focus();
        };
        
        const renderTableRows = (data, tableBodyId, type) => {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4">Tidak ada data yang cocok.</td></tr>`;
                return;
            }
            let totalJumlah = 0;

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                
                const eventDate = new Date(row.Tanggal);
                const formattedDate = eventDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                const tujuan = row.Tujuan || '';
                const noBpb = String(row['No BPB'] || '').trim().toUpperCase();
                const nama = (type === 'kirim') ? (row['Nama Pengirim'] || '') : (row['Nama Penerima'] || '');
                const kodeBarang = row['Kode Barang'] || '';
                const jumlah = parseInt(row.Jumlah) || 0;
                const keterangan = row.Keterangan || '';
                totalJumlah += jumlah;

                const normalizedTujuan = normalizeTujuan(tujuan);
                let statusHtml = '';
                
                // --- LOGIKA SELISIH ---
                const totalDikirim = allDataKirim
                    .filter(kirimRow => 
                        String(kirimRow['No BPB'] || '').trim().toUpperCase() === noBpb &&
                        normalizeTujuan(kirimRow.Tujuan) === normalizedTujuan &&
                        codesMatch(kodeBarang, kirimRow['Kode Barang'])
                    )
                    .reduce((sum, item) => sum + (parseInt(item.Jumlah) || 0), 0);

                const totalDiterima = allDataTerima
                    .filter(terimaRow => 
                        String(terimaRow['No BPB'] || '').trim().toUpperCase() === noBpb &&
                        normalizeTujuan(terimaRow.Tujuan) === normalizedTujuan &&
                        codesMatch(kodeBarang, terimaRow['Kode Barang'])
                    )
                    .reduce((sum, item) => sum + (parseInt(item.Jumlah) || 0), 0);

                const selisih = totalDiterima - totalDikirim;

                let selisihHtml = '';
                let selisihColor = 'text-green-400 font-bold';
                let selisihText = `${selisih}`;

                if (selisih < 0) { 
                    selisihColor = 'text-red-400 font-bold';
                } else if (selisih > 0) {
                    selisihColor = 'text-yellow-400 font-bold';
                    selisihText = `+${selisih}`;
                }
                
                selisihHtml = `<td class="px-2 py-2 sm:px-4 sm:py-3 text-right ${selisihColor}">${selisihText}</td>`;

                if (type === 'kirim') {
                    const isReceived = allDataTerima.some(terimaRow => 
                        String(terimaRow['No BPB'] || '').trim().toUpperCase() === noBpb &&
                        normalizeTujuan(terimaRow.Tujuan) === normalizedTujuan &&
                        codesMatch(kodeBarang, terimaRow['Kode Barang'])
                    );
                    statusHtml = isReceived ? `<td class="px-2 py-2 sm:px-4 sm:py-3 text-green-400 font-semibold">Diterima</td>` : `<td class="px-2 py-2 sm:px-4 sm:py-3 text-yellow-400">Belum Diterima</td>`;
                } else { 
                    const isInShipment = allDataKirim.some(kirimRow => 
                        String(kirimRow['No BPB'] || '').trim().toUpperCase() === noBpb &&
                        normalizeTujuan(kirimRow.Tujuan) === normalizedTujuan &&
                        codesMatch(kodeBarang, kirimRow['Kode Barang'])
                    );
                    statusHtml = isInShipment ? `<td class="px-2 py-2 sm:px-4 sm:py-3 text-green-400 font-semibold">Sesuai</td>` : `<td class="px-2 py-2 sm:px-4 sm:py-3 text-orange-400 font-semibold">Tidak Ada di Data Kirim</td>`;
                }

                tr.innerHTML = `
                    <td class="px-2 py-2 sm:px-4 sm:py-3">${formattedDate}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3">${tujuan}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3">${noBpb}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3">${nama}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3">${kodeBarang}</td>
                    <td class="px-2 py-2 sm:px-4 sm:py-3 text-right">${jumlah}</td>
                    ${selisihHtml}
                    <td class="px-2 py-2 sm:px-4 sm:py-3 text-xs" title="${keterangan}">${keterangan.substring(0, 20)}${keterangan.length > 20 ? '...' : ''}</td>
                    ${statusHtml}
                `;
                tableBody.appendChild(tr);
            });
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-gray-700 font-bold text-white border-t-2 border-gray-600';
            totalRow.innerHTML = `<td colspan="5" class="px-2 py-2 sm:px-4 sm:py-3 text-right">Total (Halaman Ini):</td><td class="px-2 py-2 sm:px-4 sm:py-3 text-right">${totalJumlah}</td><td colspan="3" class="px-2 py-2 sm:px-4 sm:py-3"></td>`;
            tableBody.appendChild(totalRow);
        };
        
        const showSkeletonLoader = (tableBodyId) => {
            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const skeletonRowHtml = `
                <tr class="bg-gray-800 border-b border-gray-700">
                    ${Array(9).fill(0).map(() => `
                        <td class="px-2 py-2 sm:px-4 sm:py-3">
                            <div class="skeleton h-4 w-full"></div>
                        </td>
                    `).join('')}
                </tr>
            `;
            for (let i = 0; i < 8; i++) {
                tableBody.innerHTML += skeletonRowHtml;
            }
        };

        const loadInitialView = async () => {
            updateSyncStatusUI('syncing');
            document.querySelectorAll('[id^="refresh-"]').forEach(btn => btn.disabled = true);
            showSkeletonLoader('table-body-kirim');
            showSkeletonLoader('table-body-terima');

            try {
                [allDataKirim, allDataTerima] = await Promise.all([
                    fetchData(scriptURLKirim),
                    fetchData(scriptURLTerima)
                ]);
                populateAutocomplete();
                applyFilters();
                showToast('Data berhasil disinkronkan.', 'success');
                updateSyncStatusUI('synced');
            } catch (error) {
                console.error("Gagal memuat data:", error);
                showToast("Gagal memuat data baru. Bekerja dengan data offline. Periksa koneksi Anda.", 'error');
                updateSyncStatusUI('offline');
            } finally {
                document.querySelectorAll('[id^="refresh-"]').forEach(btn => btn.disabled = false);
            }
        };

        const applyFilters = () => {
            const filterAndRender = (sourceData, type) => {
                const bpbFilter = document.getElementById(`filter-bpb-${type}`).value.toUpperCase();
                const kodeFilter = document.getElementById(`filter-kode-${type}`).value.toUpperCase();
                const todayString = getLocalDateString(new Date().toISOString());

                let todayData = sourceData.filter(row => getLocalDateString(row.Tanggal) === todayString);

                let filteredData = todayData;
                if (bpbFilter || kodeFilter) {
                    filteredData = todayData.filter(row => {
                        const bpbMatch = bpbFilter ? String(row['No BPB'] || '').toUpperCase().includes(bpbFilter) : true;
                        const kodeMatch = kodeFilter ? String(row['Kode Barang'] || '').toUpperCase().includes(kodeFilter) : true;
                        return bpbMatch && kodeMatch;
                    });
                }
                
                const tableId = `table-${type}`;
                const sortKey = Object.keys(sortStates).find(k => k.startsWith(tableId));
                if (sortKey) {
                    const column = sortKey.substring(tableId.length + 1);
                    const direction = sortStates[sortKey];
                    filteredData = sortData(filteredData, column, direction);
                }

                window.requestAnimationFrame(() => {
                    renderTableRows(filteredData, `table-body-${type}`, type);
                });
            };

            filterAndRender(allDataKirim, 'kirim');
            filterAndRender(allDataTerima, 'terima');
        };
        
        const createSubmissionFingerprint = (commonData, items) => {
            const normalizedBpb = String(commonData['No BPB'] || '').trim().toUpperCase();
            const normalizedTujuan = normalizeTujuan(commonData.Tujuan);
            const sortedItems = [...items].sort((a, b) => {
                const codeA = String(a['Kode Barang'] || '').trim().toUpperCase();
                const codeB = String(b['Kode Barang'] || '').trim().toUpperCase();
                return codeA.localeCompare(codeB);
            });
            const itemsString = sortedItems.map(item => {
                const code = String(item['Kode Barang'] || '').trim().toUpperCase();
                const qty = parseInt(item['Jumlah']) || 0;
                return `${code}:${qty}`;
            }).join(',');
            return `${normalizedBpb}|${normalizedTujuan}|${itemsString}`;
        };
        
        const isDuplicateSubmission = (newFingerprint, type) => {
            const queueKey = type === 'kirim' ? 'submissionQueueKirim' : 'submissionQueueTerima';
            const queue = JSON.parse(localStorage.getItem(queueKey) || '[]');
            
            if (queue.some(item => item.fingerprint === newFingerprint)) {
                return true;
            }
            const sourceData = type === 'kirim' ? allDataKirim : allDataTerima;
            const [bpb, tujuan, itemsStr] = newFingerprint.split('|');
            if (!itemsStr) return false;
            const newItems = itemsStr.split(',');
            const existingItemsForBpb = new Set();
            sourceData.forEach(row => {
                const rowBpb = String(row['No BPB'] || '').trim().toUpperCase();
                const rowTujuan = normalizeTujuan(row.Tujuan);
                if (rowBpb === bpb && rowTujuan === tujuan) {
                    const itemCode = String(row['Kode Barang'] || '').trim().toUpperCase();
                    const itemQty = parseInt(row.Jumlah) || 0;
                    existingItemsForBpb.add(`${itemCode}:${itemQty}`);
                }
            });

            if (existingItemsForBpb.size === 0) return false;

            for (const newItem of newItems) {
                if (existingItemsForBpb.has(newItem)) return true;
            }
            return false;
        };
        
        function handleFormSubmit(form) {
            if (isSubmitting) return;

            const submissionId = `SUB-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const submitButton = form.querySelector('.submit-button');
            const originalButtonHTML = submitButton.innerHTML;
            
            try {
                isSubmitting = true;
                submitButton.disabled = true;
                submitButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">...</svg> MENGIRIM...`;

                const itemRows = form.querySelectorAll('.item-row');
                const items = Array.from(itemRows).map(row => ({
                    "Kode Barang": row.querySelector('input[name=\"Kode Barang\"]').value,
                    "Jumlah": row.querySelector('input[name=\"Jumlah\"]').value
                })).filter(item => item["Kode Barang"] && item["Jumlah"]);

                if (items.length === 0) {
                    showToast('Harap isi setidaknya satu item barang.', 'warning');
                    throw new Error("No items to submit."); 
                }
                
                const isKirimForm = form.id === 'form-kirim';
                const commonData = {
                    Tanggal: document.getElementById(isKirimForm ? 'tanggal-kirim' : 'tanggal-terima').value,
                    'No BPB': document.getElementById(isKirimForm ? 'no_bpb-kirim' : 'no_bpb-terima').value,
                    Tujuan: document.getElementById(isKirimForm ? 'tujuan-kirim' : 'tujuan-terima').value,
                    Nama: document.getElementById(isKirimForm ? 'pengirim-kirim' : 'penerima-terima').value,
                    Keterangan: document.getElementById(isKirimForm ? 'keterangan-kirim' : 'keterangan-terima').value,
                };

                commonData.SubmissionID = submissionId;

                if (isAntiDuplicateOn) {
                    const fingerprint = createSubmissionFingerprint(commonData, items);
                    if (isDuplicateSubmission(fingerprint, isKirimForm ? 'kirim' : 'terima')) {
                        showToast('Data ini sudah pernah dikirim sebelumnya.', 'error');
                        if (isAudioReady) { synth.triggerAttackRelease("C4", "8n", Tone.now()); }
                        throw new Error("Duplicate submission detected."); 
                    }
                }
                
                const itemCodesList = document.getElementById('item-codes-list');
                items.forEach(item => {
                    const newCode = String(item["Kode Barang"] || '').trim().toUpperCase();
                    if (newCode && !allItemCodes.has(newCode)) {
                        allItemCodes.add(newCode);
                        const option = document.createElement('option');
                        option.value = newCode;
                        itemCodesList.appendChild(option);
                    }
                });

                const newRowDataCommon = { ...commonData, 'Nama Pengirim': isKirimForm ? commonData.Nama : '', 'Nama Penerima': !isKirimForm ? commonData.Nama : '' };
                delete newRowDataCommon.Nama;
                
                const queueKey = isKirimForm ? 'submissionQueueKirim' : 'submissionQueueTerima';
                const queue = JSON.parse(localStorage.getItem(queueKey) || '[]');
                const logDetails = `Submit form ${form.id} with ${items.length} items. ID: ${submissionId}`;
                const submissionFingerprint = createSubmissionFingerprint(commonData, items);
                
                queue.push({ data: newRowDataCommon, items: items, logDetails: logDetails, fingerprint: submissionFingerprint });
                localStorage.setItem(queueKey, JSON.stringify(queue));

                showToast('Data ditambahkan ke antrean pengiriman.', 'success');
                if (isAudioReady) {
                    const now = Tone.now();
                    synth.triggerAttackRelease("G5", "16n", now);
                    synth.triggerAttackRelease("A5", "16n", now + 0.1);
                    synth.triggerAttackRelease("C6", "16n", now + 0.2);
                    synth.triggerAttackRelease("E6", "16n", now + 0.3);
                }

                const targetArray = isKirimForm ? allDataKirim : allDataTerima;
                items.forEach(item => {
                    targetArray.push({ ...newRowDataCommon, 'Kode Barang': item['Kode Barang'], 'Jumlah': item.Jumlah, });
                });

                applyFilters();
                form.reset();
                clearLocalStorage(form.id);
                loadFormData(form.id);
                
                processSubmissionQueue();

            } catch (error) {
                if (error.message !== "No items to submit." && error.message !== "Duplicate submission detected.") {
                    console.error("Submission error:", error);
                    showToast('Terjadi kesalahan saat memproses data.', 'error');
                }
            } finally {
                // Setelah selesai, status tombol akan diatur ulang oleh updateSyncStatusUI
                 setTimeout(() => {
                    isSubmitting = false;
                    updateSyncStatusUI(syncStatus); // Atur ulang state tombol sesuai status koneksi
                }, 500);
            }
        }

        const saveFormData = (formId) => {
            const form = document.getElementById(formId);
            if (!form) return;
            const isKirimForm = form.id === 'form-kirim';
            const formData = {
                no_bpb: document.getElementById(isKirimForm ? 'no_bpb-kirim' : 'no_bpb-terima').value,
                tujuan: document.getElementById(isKirimForm ? 'tujuan-kirim' : 'tujuan-terima').value,
                nama: document.getElementById(isKirimForm ? 'pengirim-kirim' : 'penerima-terima').value,
                keterangan: document.getElementById(isKirimForm ? 'keterangan-kirim' : 'keterangan-terima').value,
                items: Array.from(form.querySelectorAll('.item-row')).map(row => ({ 'Kode Barang': row.querySelector('input[name="Kode Barang"]').value, 'Jumlah': row.querySelector('input[name="Jumlah"]').value }))
            };
            localStorage.setItem(formId, JSON.stringify(formData));
        };

        const loadFormData = (formId) => {
            const form = document.getElementById(formId);
            if (!form) return;
            const isKirimForm = form.id === 'form-kirim';
            
            form.reset();
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            document.getElementById(isKirimForm ? 'tanggal-kirim' : 'tanggal-terima').value = formattedDate;

            const itemsContainer = form.querySelector('.space-y-4');
            while (itemsContainer.children.length > 1) { itemsContainer.removeChild(itemsContainer.lastChild); }

            const savedData = localStorage.getItem(formId);
            if (!savedData) return;

            const data = JSON.parse(savedData);
            document.getElementById(isKirimForm ? 'no_bpb-kirim' : 'no_bpb-terima').value = data.no_bpb || '';
            document.getElementById(isKirimForm ? 'tujuan-kirim' : 'tujuan-terima').value = data.tujuan || '';
            document.getElementById(isKirimForm ? 'pengirim-kirim' : 'penerima-terima').value = data.nama || '';
            document.getElementById(isKirimForm ? 'keterangan-kirim' : 'keterangan-terima').value = data.keterangan || '';
            
            if (data.items && data.items.length > 0) {
                const firstRow = itemsContainer.querySelector('.item-row');
                firstRow.querySelector('input[name="Kode Barang"]').value = data.items[0]['Kode Barang'] || '';
                firstRow.querySelector('input[name="Jumlah"]').value = data.items[0]['Jumlah'] || '';
                for (let i = 1; i < data.items.length; i++) {
                    const item = data.items[i];
                    addNewItemRow(itemsContainer);
                    const newRow = itemsContainer.lastChild;
                    newRow.querySelector('input[name="Kode Barang"]').value = item['Kode Barang'] || '';
                    newRow.querySelector('input[name="Jumlah"]').value = item['Jumlah'] || '';
                }
            }
        };

        const clearLocalStorage = (formId) => {
            localStorage.removeItem(formId);
        };
        
        function checkBreakTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();

            if (hours === 11 && minutes === 50 && !hasShownBreakNotification) {
                breakNotification.classList.add('show');
                hasShownBreakNotification = true;
                setTimeout(() => { breakNotification.classList.remove('show'); }, 60000); 
            }
            if (hours === 11 && minutes === 51) { hasShownBreakNotification = false; }
        }
        
        const resetAppState = () => {
            document.body.classList.remove('app-active');
            appContainer.style.opacity = '0';
            
            setTimeout(() => {
                appContainer.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                requestAnimationFrame(() => { loginScreen.style.opacity = '1'; });
                loginForm.reset();
                document.getElementById('password').value = '';
                loginError.classList.add('hidden');
                if (breakCheckInterval) clearInterval(breakCheckInterval);
                if (resyncInterval) clearInterval(resyncInterval);
                breakCheckInterval = null;
                resyncInterval = null;
                currentUserRole = null;
                allDataKirim = [];
                allDataTerima = [];
                sortStates = {};
            }, 500);
        };

        const setupEventListeners = () => {
            formKirim.addEventListener('click', (e) => {
                const addButton = e.target.closest('#add-item-btn-kirim');
                const removeButton = e.target.closest('.remove-item-btn');
                if (addButton) addNewItemRow(document.getElementById('items-container-kirim'));
                else if (removeButton) removeButton.closest('.item-row').remove();
            });
            formTerima.addEventListener('click', (e) => {
                const addButton = e.target.closest('#add-item-btn-terima');
                const removeButton = e.target.closest('.remove-item-btn');
                if (addButton) addNewItemRow(document.getElementById('items-container-terima'));
                else if (removeButton) removeButton.closest('.item-row').remove();
            });
            formKirim.addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(formKirim); });
            formTerima.addEventListener('submit', (e) => { e.preventDefault(); handleFormSubmit(formTerima); });

            document.body.addEventListener('click', (e) => {
                const sortableHeader = e.target.closest('.sortable');
                if (sortableHeader) {
                    const column = sortableHeader.dataset.column;
                    const table = sortableHeader.closest('table');
                    if (!table) return;
                    const tableId = table.id;
                    const currentSortKey = tableId + '-' + column;
                    let newDirection = (sortStates[currentSortKey] === 'asc') ? 'desc' : 'asc';
                    Object.keys(sortStates).forEach(key => { if (key.startsWith(tableId)) delete sortStates[key]; });
                    table.querySelectorAll('.sortable').forEach(th => th.classList.remove('asc', 'desc'));
                    sortStates[currentSortKey] = newDirection;
                    sortableHeader.classList.add(newDirection);
                    applyFilters();
                }
            });

            document.getElementById('refresh-kirim-btn').addEventListener('click', loadInitialView);
            document.getElementById('refresh-terima-btn').addEventListener('click', loadInitialView);
            manualSyncBtn.addEventListener('click', loadInitialView);

            const antiDuplicateToggle = document.getElementById('anti-duplicate-toggle');
            const antiDuplicateLabel = document.getElementById('anti-duplicate-label').querySelector('span');
            antiDuplicateToggle.addEventListener('change', () => {
                isAntiDuplicateOn = antiDuplicateToggle.checked;
                localStorage.setItem('isAntiDuplicateOn', isAntiDuplicateOn);
                antiDuplicateLabel.textContent = isAntiDuplicateOn ? 'Anti Duplikat: ON' : 'Anti Duplikat: OFF';
                showToast(`Fitur Anti Duplikat ${isAntiDuplicateOn ? 'diaktifkan' : 'dinonaktifkan'}.`, 'success');
            });

            const antiLagToggle = document.getElementById('anti-lag-toggle');
            const antiLagLabel = document.getElementById('anti-lag-label').querySelector('span');
            const updatePerformanceMode = () => {
                document.querySelectorAll('.table-filter').forEach(input => input.removeEventListener('input', debouncedApplyFilters));
                formKirim.removeEventListener('input', debouncedSaveKirim);
                formTerima.removeEventListener('input', debouncedSaveTerima);
                isFastModeOn = antiLagToggle.checked;
                localStorage.setItem('isFastModeOn', isFastModeOn);
                antiLagLabel.textContent = isFastModeOn ? 'Mode Cepat' : 'Mode Lancar';
                const saveDelay = isFastModeOn ? 300 : 1000;
                const filterDelay = isFastModeOn ? 50 : 750;
                debouncedSaveKirim = debounce(() => saveFormData('form-kirim'), saveDelay);
                debouncedSaveTerima = debounce(() => saveFormData('form-terima'), saveDelay);
                debouncedApplyFilters = debounce(applyFilters, filterDelay);
                document.querySelectorAll('.table-filter').forEach(input => {
                    input.addEventListener('input', debouncedApplyFilters);
                });
                formKirim.addEventListener('input', debouncedSaveKirim);
                formTerima.addEventListener('input', debouncedSaveTerima);
            };
            antiLagToggle.addEventListener('change', () => {
                updatePerformanceMode();
                showToast(antiLagToggle.checked ? 'Mode Cepat diaktifkan: Respon instan.' : 'Mode Lancar diaktifkan: Anti-jeda saat mengetik.', 'success');
            });
            const savedFastMode = localStorage.getItem('isFastModeOn') === 'true';
            antiLagToggle.checked = savedFastMode;
            updatePerformanceMode(); 

            document.body.addEventListener('input', (e) => {
                if (e.target.classList.contains('auto-uppercase')) {
                    const start = e.target.selectionStart;
                    const end = e.target.selectionEnd;
                    e.target.value = e.target.value.toUpperCase();
                    e.target.setSelectionRange(start, end);
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('userLoginData');
                localStorage.removeItem('isAntiDuplicateOn');
                resetAppState();
            });
        };

        const tryResync = () => {
            if (syncStatus === 'offline') {
                console.log("Mencoba sinkronisasi ulang otomatis...");
                loadInitialView();
            }
        };

        document.body.addEventListener('click', async () => {
            if (!isAudioReady) {
                await Tone.start();
                synth = new Tone.Synth().toDestination();
                isAudioReady = true;
            }
        }, { once: true });

        const savedLoginData = localStorage.getItem('userLoginData');
        if (savedLoginData) {
            const userData = JSON.parse(savedLoginData);
            currentUserRole = userData.role;

            loginScreen.classList.add('hidden');
            loginScreen.style.opacity = '0';
            appContainer.classList.remove('hidden');
            appContainer.style.opacity = '1';
            document.body.classList.add('app-active');

            const savedAntiDuplicate = localStorage.getItem('isAntiDuplicateOn');
            isAntiDuplicateOn = savedAntiDuplicate === null ? true : (savedAntiDuplicate === 'true');
            const antiDuplicateToggle = document.getElementById('anti-duplicate-toggle');
            const antiDuplicateLabel = document.getElementById('anti-duplicate-label').querySelector('span');
            antiDuplicateToggle.checked = isAntiDuplicateOn;
            antiDuplicateLabel.textContent = isAntiDuplicateOn ? 'Anti Duplikat: ON' : 'Anti Duplikat: OFF';

            setupUIForRole(currentUserRole);
            loadFormData(currentUserRole === 'kirim' ? 'form-kirim' : 'form-terima');
            loadInitialView();
            setInterval(processSubmissionQueue, 5000); // Check queue every 5 seconds
            checkBreakTime();
            breakCheckInterval = setInterval(checkBreakTime, 30000);
            resyncInterval = setInterval(tryResync, 30000); // Try to resync every 30s if offline
        } else {
            appContainer.classList.add('hidden');
            appContainer.style.opacity = '0';
            document.body.classList.remove('app-active');
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const role = document.getElementById('role-select').value;
            const password = document.getElementById('password').value;
            
            if (userCredentials[role] && userCredentials[role].password === password) {
                if(isAudioReady) {
                    const now = Tone.now();
                    synth.triggerAttackRelease("C6", "16n", now);
                    synth.triggerAttackRelease("G5", "16n", now + 0.15);
                }
                
                currentUserRole = role;
                const loginData = { role: currentUserRole };
                localStorage.setItem('userLoginData', JSON.stringify(loginData));
                isAntiDuplicateOn = true;
                localStorage.setItem('isAntiDuplicateOn', 'true');
                const antiDuplicateToggle = document.getElementById('anti-duplicate-toggle');
                const antiDuplicateLabel = document.getElementById('anti-duplicate-label').querySelector('span');
                antiDuplicateToggle.checked = true;
                antiDuplicateLabel.textContent = 'Anti Duplikat: ON';

                document.body.classList.add('app-active');
                loginScreen.style.opacity = '0';
                
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    requestAnimationFrame(() => { appContainer.style.opacity = '1'; });
                }, 500);

                loginError.classList.add('hidden');
                setupUIForRole(currentUserRole);
                loadFormData(currentUserRole === 'kirim' ? 'form-kirim' : 'form-terima');
                loadInitialView();
                setInterval(processSubmissionQueue, 5000);
                checkBreakTime();
                breakCheckInterval = setInterval(checkBreakTime, 30000);
                resyncInterval = setInterval(tryResync, 30000);
            } else {
                loginError.classList.add('hidden');
            }
        });

        setupEventListeners();

    </script>
</body>
</html>

